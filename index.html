<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AV Cockpit Rhythm Final</title>
<style>
    /* === ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š === */
    :root {
        --bg-main: #050008;
        --panel-bg: #100508;
        --neon-pink: #ff0055;
        --neon-blue: #00d2ff;
        --neon-green: #00ff99;
        --text-color: #eee;
    }
    body { background: var(--bg-main); margin: 0; overflow: hidden; font-family: 'Courier New', sans-serif; color: var(--text-color); user-select: none; }
    
    #container { display: flex; width: 100vw; height: 100vh; }

    /* å·¦å´ï¼šå‹•ç”»ã‚¹ãƒ†ãƒ¼ã‚¸ */
    #video-stage {
        flex: 1; position: relative; background: #000; overflow: hidden;
        border-right: 4px solid var(--neon-pink);
        box-shadow: 0 0 20px rgba(255, 0, 85, 0.3);
    }
    video { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
    
    /* ã‚¬ã‚¤ãƒ‰è¡¨ç¤º */
    .overlay-guide {
        position: absolute; bottom: 20px; left: 0; width: 100%; 
        text-align: center; color: rgba(255,255,255,0.4); font-size: 12px; pointer-events: none;
        text-shadow: 0 0 5px #000;
    }

    /* å³å´ï¼šã‚³ã‚¯ãƒ”ãƒƒãƒˆãƒ‘ãƒãƒ« */
    #cockpit-panel {
        width: 340px; background: var(--panel-bg);
        display: flex; flex-direction: column;
        padding: 10px; box-sizing: border-box;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 50;
    }

    .panel-section {
        margin-bottom: 10px; border: 1px solid var(--neon-blue);
        background: rgba(0, 20, 30, 0.6); padding: 8px; border-radius: 6px;
        position: relative;
    }
    .title { font-size: 11px; color: var(--neon-blue); margin-bottom: 5px; letter-spacing: 1px; font-weight: bold; }

    /* UIãƒœã‚¿ãƒ³ */
    .btn-group { display: flex; gap: 5px; }
    .btn {
        flex: 1; background: #222; border: 1px solid var(--neon-blue); color: #fff;
        padding: 10px 0; border-radius: 4px; font-weight: bold; cursor: pointer; text-align: center;
        transition: all 0.1s; font-size: 13px;
    }
    .btn-main { background: linear-gradient(135deg, var(--neon-pink), #aa0033); border: none; box-shadow: 0 0 10px var(--neon-pink); }
    .btn-skip { background: #004455; border-color: var(--neon-blue); color: var(--neon-blue); }
    .btn:active { transform: scale(0.96); filter: brightness(1.2); }
    input[type="file"] { display: none; }

    /* ãƒ¡ãƒ¼ã‚¿ãƒ¼é¡ */
    #bpm-display { 
        font-size: 24px; font-weight: bold; text-align: center; margin: 5px 0; 
        color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green);
    }
    #bpm-sub { font-size: 10px; text-align: center; color: #888; }

    /* ãƒ’ãƒ¼ãƒˆã‚²ãƒ¼ã‚¸ */
    .heat-container { width: 100%; height: 6px; background: #333; margin-top: 5px; border-radius: 3px; overflow: hidden; }
    #heat-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink)); transition: width 0.1s; }

    /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ãƒãƒ¼ãƒ„ãƒ¬ãƒ¼ãƒ³ */
    #notes-lane-wrap {
        flex: 1; position: relative; overflow: hidden;
        background: linear-gradient(90deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 100%);
        border-top: 2px solid var(--neon-blue);
        border-bottom: 2px solid var(--neon-blue);
        margin-bottom: 10px;
    }
    #notes-canvas { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; }
    
    /* åˆ¤å®šãƒ©ã‚¤ãƒ³ï¼ˆå·¦å´ã«ç¸¦ç·šï¼‰ */
    #hit-line {
        position: absolute; top: 0; left: 60px; width: 4px; height: 100%;
        background: rgba(255, 255, 255, 0.6); z-index: 5;
        box-shadow: 0 0 15px #fff;
    }

    /* ã‚¹ãƒšã‚¯ãƒˆãƒ©ãƒ  */
    #spectrum-wrap {
        height: 80px; position: relative; background: #000;
        border: 1px solid #444; overflow: hidden;
    }
    #spectrum-canvas { width: 100%; height: 100%; }

    /* åˆæœŸãƒ­ãƒ¼ãƒ‰ç”»é¢ */
    #init-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
        background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .start-btn {
        padding: 20px 60px; font-size: 24px; border-radius: 50px; margin-top: 30px; cursor: pointer;
        background: var(--neon-pink); color: #fff; font-weight: bold; border: 2px solid #fff;
        box-shadow: 0 0 30px var(--neon-pink); animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
</style>
</head>
<body>

<div id="container">
    <div id="video-stage">
        <video id="mainVideo" playsinline crossorigin="anonymous"></video>
        <div class="overlay-guide">Double Tap Video to Fullscreen Mode</div>
    </div>

    <div id="cockpit-panel">
        
        <div class="panel-section">
            <div class="title">SYSTEM CONTROL</div>
            <div class="btn-group">
                <label class="btn btn-main">
                    ğŸ“‚ ADD FILES
                    <input type="file" id="subFileInput" multiple accept="video/*">
                </label>
                <button class="btn btn-skip" onclick="manualSkip()">SKIP â­</button>
            </div>
        </div>

        <div class="panel-section">
            <div class="title">ENGINE HEAT (INERTIA)</div>
            <div id="bpm-display">IDLE</div>
            <div id="bpm-sub">WAITING INPUT...</div>
            <div class="heat-container">
                <div id="heat-bar"></div>
            </div>
        </div>

        <div class="panel-section" style="flex:1; display:flex; flex-direction:column; padding:0; border:none; background:none;">
            <div class="title" style="padding-left:5px;">RHYTHM FLOW &gt;&gt;&gt;</div>
            <div id="notes-lane-wrap">
                <div id="hit-line"></div>
                <canvas id="notes-canvas"></canvas>
            </div>
        </div>

        <div class="panel-section" style="padding:5px;">
            <div class="title">AUDIO VISUALIZER</div>
            <div id="spectrum-wrap">
                <canvas id="spectrum-canvas"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="init-screen">
    <h1 style="color:var(--neon-pink); text-shadow:0 0 20px var(--neon-pink); font-size:40px; margin:0;">AV COCKPIT</h1>
    <div style="color:var(--neon-blue); letter-spacing:4px; margin-bottom:20px;">FINAL EDITION</div>
    
    <label class="start-btn">
        ğŸš€ LAUNCH SYSTEM
        <input type="file" id="mainFileInput" multiple accept="video/*">
    </label>
</div>

<script>
    // === è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===
    const INTERVAL_SLOW = 4000; // æœ€ã‚‚é…ã„é–“éš” (4ç§’)
    const INTERVAL_FAST = 400;  // æœ€ã‚‚é€Ÿã„é–“éš” (0.4ç§’)
    const NOTE_SPEED = 6;       // ãƒãƒ¼ãƒ„ã®æ¨ªç§»å‹•é€Ÿåº¦
    const HIT_X = 60;           // åˆ¤å®šãƒ©ã‚¤ãƒ³ã®Xåº§æ¨™

    // === ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•° ===
    const video = document.getElementById('mainVideo');
    const notesCanvas = document.getElementById('notes-canvas');
    const specCanvas = document.getElementById('spectrum-canvas');
    const nCtx = notesCanvas.getContext('2d');
    const sCtx = specCanvas.getContext('2d');
    
    const bpmDisplay = document.getElementById('bpm-display');
    const bpmSub = document.getElementById('bpm-sub');
    const heatBar = document.getElementById('heat-bar');
    const initScreen = document.getElementById('init-screen');

    let playlist = [];
    let audioCtx, analyser;
    let notes = [];
    let cruiseTimer = null;
    
    // ãƒªã‚ºãƒ åˆ¶å¾¡
    let nextNoteTime = 0;
    
    // â˜…ãƒ’ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ  (æ…£æ€§åˆ¶å¾¡)
    // 0.0 = å†·ãˆå†·ãˆ, 1.0 = ã‚ªãƒ¼ãƒãƒ¼ãƒ’ãƒ¼ãƒˆå¯¸å‰
    let currentHeat = 0; 

    // === ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ===
    document.getElementById('mainFileInput').addEventListener('change', handleFileSelect);
    document.getElementById('subFileInput').addEventListener('change', handleFileSelect);

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        playlist = playlist.concat(files);
        shuffleArray(playlist);
        initAudio(); 

        if (initScreen.style.display !== 'none') {
            initScreen.style.display = 'none';
            playNext();
            requestAnimationFrame(renderLoop);
        }
    }

    // === å…¨ç”»é¢åŒ–ãƒ­ã‚¸ãƒƒã‚¯ (å…¨ä½“ã‚’Fullscreen) ===
    let lastTap = 0;
    document.getElementById('video-stage').addEventListener('click', () => {
        const now = new Date().getTime();
        if (now - lastTap < 300) {
            // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ™‚: documentElement(ãƒšãƒ¼ã‚¸å…¨ä½“)ã‚’ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
        lastTap = now;
    });

    function initAudio() {
        if(audioCtx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.85; // ãªã‚ã‚‰ã‹ã«
        const source = audioCtx.createMediaElementSource(video);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function playNext() {
        if(playlist.length === 0) return;
        if(cruiseTimer) clearTimeout(cruiseTimer);
        
        // å‹•ç”»å…¥ã‚Œæ›¿ãˆ
        const file = playlist.shift();
        playlist.push(file);

        video.src = URL.createObjectURL(file);
        video.play().catch(()=>{});
        
        // é–‹å§‹ä½ç½®ãƒ©ãƒ³ãƒ€ãƒ  (30%ã€œ70%)
        video.onloadedmetadata = () => { 
            video.currentTime = video.duration * (0.3 + Math.random() * 0.4); 
            // å‹•ç”»ãŒå¤‰ã‚ã£ãŸç¬é–“ã¯ãƒ’ãƒ¼ãƒˆã‚’å°‘ã—ãƒªã‚»ãƒƒãƒˆï¼ˆä½™éŸ»ã¯æ®‹ã™ï¼‰
            currentHeat = currentHeat * 0.5;
        };
        
        // ã‚ªãƒ¼ãƒˆã‚¯ãƒ«ãƒ¼ã‚º (3åˆ†ã€œ5åˆ†)
        const duration = (180 + Math.random() * 120) * 1000;
        cruiseTimer = setTimeout(playNext, duration);
    }

    function manualSkip() {
        playNext();
    }

    // === ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ===
    function renderLoop() {
        requestAnimationFrame(renderLoop);
        if(!analyser) return;

        // Canvasã‚µã‚¤ã‚ºåŒæœŸ
        syncCanvas(notesCanvas);
        syncCanvas(specCanvas);

        // --- 1. ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè§£æ ---
        const bufferLen = analyser.frequencyBinCount;
        const data = new Uint8Array(bufferLen);
        analyser.getByteFrequencyData(data);

        drawSpectrum(data, bufferLen);

        // éŸ³é‡ã‚¨ãƒãƒ«ã‚®ãƒ¼è¨ˆç®— (ä½éŸ³ã€œä¸­éŸ³åŸŸ)
        let energy = 0;
        const range = Math.floor(bufferLen * 0.5);
        for(let i=0; i<range; i++) energy += data[i];
        energy = energy / range; // 0ã€œ255

        // --- 2. ãƒ’ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ  (æ…£æ€§ç‰©ç†æ¼”ç®—) ---
        // åŠ é€Ÿ: éŸ³é‡ãŒä¸€å®š(20)ã‚’è¶…ãˆãŸã‚‰åŠ ç†±
        if (energy > 20) {
            // éŸ³ãŒå¤§ãã„ã»ã©æ—©ãæ¸©ã¾ã‚‹
            // ä¿‚æ•° 0.005 ã§ã€Œã˜ã‚ã˜ã‚ã€ä¸Šã’ã‚‹
            currentHeat += 0.005 * (energy / 100);
        }

        // è‡ªç„¶å†·å´: å¸¸ã«å°‘ã—ãšã¤å†·ã‚ã‚‹
        currentHeat -= 0.002;

        // ã‚¯ãƒ©ãƒ³ãƒ— (0.0 ã€œ 1.0)
        if (currentHeat < 0) currentHeat = 0;
        if (currentHeat > 1) currentHeat = 1;

        // ãƒ’ãƒ¼ãƒˆãƒãƒ¼æ›´æ–°
        heatBar.style.width = (currentHeat * 100) + "%";
        
        // ãƒ’ãƒ¼ãƒˆå€¤ã‹ã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨ˆç®— (ãƒªãƒ‹ã‚¢è£œå®Œ)
        // Heat 0.0 -> Slow(4000ms), Heat 1.0 -> Fast(400ms)
        const currentInterval = INTERVAL_SLOW - (currentHeat * (INTERVAL_SLOW - INTERVAL_FAST));

        // è¡¨ç¤ºæ›´æ–°
        const percent = Math.round(currentHeat * 100);
        bpmDisplay.innerText = `Lv.${percent}`;
        bpmSub.innerText = `INT: ${(currentInterval/1000).toFixed(2)}s`;
        
        // è‰²å¤‰åŒ– (é’ -> ãƒ”ãƒ³ã‚¯ -> èµ¤)
        const hue = 180 + (currentHeat * 180);
        bpmDisplay.style.color = `hsl(${hue}, 100%, 60%)`;
        heatBar.style.background = `hsl(${hue}, 100%, 60%)`;

        // --- 3. ãƒãƒ¼ãƒ„ç”Ÿæˆ (æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨) ---
        const now = Date.now();
        if (now > nextNoteTime) {
            spawnNote(currentHeat, hue);
            nextNoteTime = now + currentInterval;
        }

        drawNotes();
    }

    // Canvasã‚µã‚¤ã‚ºèª¿æ•´
    function syncCanvas(cvs) {
        const p = cvs.parentElement;
        if (cvs.width !== p.clientWidth || cvs.height !== p.clientHeight) {
            cvs.width = p.clientWidth;
            cvs.height = p.clientHeight;
        }
    }

    function drawSpectrum(data, bufferLen) {
        const W = specCanvas.width; const H = specCanvas.height;
        sCtx.clearRect(0, 0, W, H);

        const barW = (W / bufferLen) * 2.5;
        let x = 0;

        for(let i = 0; i < bufferLen; i++) {
            const barH = (data[i] / 255) * H;
            const hue = (i / bufferLen) * 360;
            sCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            sCtx.fillRect(x, H - barH, barW, barH);
            x += barW + 1;
            if(x > W) break;
        }
    }

    function spawnNote(heat, hue) {
        const H = notesCanvas.height;
        
        // æ¿€ã—ã„(HeatãŒé«˜ã„)ã»ã©ã€å¤ªã„ãƒãƒ¼ã«ã™ã‚‹
        let height = H * (0.3 + (heat * 0.6)); 
        
        notes.push({
            x: notesCanvas.width + 50, // ç”»é¢å¤–(å³)ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
            y: (H - height) / 2,       // ä¸Šä¸‹ä¸­å¤®
            width: 20,                 // ãƒãƒ¼ã®å¹…
            height: height,
            color: `hsl(${hue}, 100%, 60%)`,
            glow: heat * 20
        });
    }

    function drawNotes() {
        const W = notesCanvas.width; const H = notesCanvas.height;
        nCtx.clearRect(0, 0, W, H);

        // åˆ¤å®šãƒ©ã‚¤ãƒ³æç”»
        const line = document.getElementById('hit-line');

        for (let i = notes.length - 1; i >= 0; i--) {
            const n = notes[i];
            
            // å·¦ã¸ç§»å‹•
            n.x -= NOTE_SPEED;

            // æç”»
            nCtx.shadowBlur = 10 + n.glow;
            nCtx.shadowColor = n.color;
            nCtx.fillStyle = n.color;
            nCtx.globalAlpha = 0.9;
            
            nCtx.beginPath();
            nCtx.roundRect(n.x, n.y, n.width, n.height, 4);
            nCtx.fill();

            // åˆ¤å®šãƒ©ã‚¤ãƒ³é€šéã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (å·¦ç«¯ HIT_X ã‚’é€šéã—ãŸæ™‚)
            if (n.x < HIT_X && n.x > HIT_X - NOTE_SPEED - 5) {
                line.style.background = n.color;
                line.style.boxShadow = `0 0 30px ${n.color}`;
                setTimeout(() => {
                    line.style.background = 'rgba(255,255,255,0.6)';
                    line.style.boxShadow = '0 0 15px #fff';
                }, 100);
            }

            // ç”»é¢å¤–ã«å‡ºãŸã‚‰å‰Šé™¤
            if (n.x < -50) notes.splice(i, 1);
        }
        nCtx.shadowBlur = 0;
    }
</script>
</body>
</html>
