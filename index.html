<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AV Cruise AI Player</title>
<style>
    /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */
    body { 
        background-color: #000; 
        color: #fff; 
        margin: 0; 
        overflow: hidden; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
    }
    
    #player-container { 
        width: 100vw; 
        height: 100vh; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        position: relative; 
    }
    
    video { 
        width: 100%; 
        height: 100%; 
        object-fit: contain; /* ç”»é¢ã«åã‚ã‚‹ */
    }
    
    /* æ“ä½œãƒ‘ãƒãƒ«ï¼ˆåˆæœŸç”»é¢ãƒ»ã‚¿ãƒƒãƒ—ã§è¡¨ç¤ºï¼‰ */
    #controls {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); 
        z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: opacity 0.4s;
    }
    #controls.hidden { opacity: 0; pointer-events: none; }
    
    h1 { margin-bottom: 30px; letter-spacing: 2px; font-size: 24px; }
    h1 span { color: #ff0055; font-size: 0.6em; vertical-align: middle; }

    /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ */
    .file-btn {
        background: linear-gradient(45deg, #ff0055, #ff5500);
        color: white; padding: 16px 32px; 
        border-radius: 50px; font-weight: bold; font-size: 18px; cursor: pointer;
        box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4);
        text-align: center;
        border: 2px solid rgba(255,255,255,0.2);
    }
    .file-btn:active { transform: scale(0.95); }
    input[type="file"] { display: none; }
    
    #status { margin-top: 20px; font-size: 14px; color: #aaa; min-height: 20px; padding: 0 20px; text-align: center; line-height: 1.5; }
    
    /* è§£æä¸­ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º */
    #analyzing-overlay {
        position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6); border: 1px solid #333;
        padding: 8px 20px; border-radius: 20px;
        font-size: 13px; color: #00ff88; pointer-events: none; opacity: 0;
        transition: opacity 0.3s;
        display: flex; align-items: center; gap: 10px;
    }
    #analyzing-overlay.show { opacity: 1; }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .spinner {
        width: 10px; height: 10px; border: 2px solid #00ff88; border-top-color: transparent; border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* æ¬¡ã¸ãƒœã‚¿ãƒ³ */
    #skip-btn {
        position: absolute; bottom: 30px; right: 30px; z-index: 90;
        background: rgba(255, 255, 255, 0.15); 
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.3); color: #fff;
        padding: 0; border-radius: 50%; width: 64px; height: 64px;
        font-size: 12px; font-weight: bold; letter-spacing: 1px;
        display: none; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    #skip-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }
</style>
</head>
<body>

<canvas id="hiddenCanvas" style="display:none;"></canvas>

<div id="controls">
    <h1>AV Cruise <span>AI AUTO</span></h1>
    <label class="file-btn">
        ğŸ“‚ å‹•ç”»ã‚’é¸æŠ
        <br><span style="font-size:0.7em; font-weight:normal;">(è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ¨å¥¨)</span>
        <input type="file" id="fileInput" multiple accept="video/*">
    </label>
    <div id="status">ã‚¹ãƒãƒ›å†…ã®å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>é€šä¿¡é‡ã¯ã‹ã‹ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<div id="player-container">
    <video id="mainVideo" playsinline controls></video>
    <div id="analyzing-overlay"><div class="spinner"></div><span id="analyze-text">AI Scanning...</span></div>
</div>

<button id="skip-btn" onclick="playNext()">NEXT</button>

<script>
    // ==========================================
    //  è¨­å®šã‚¨ãƒªã‚¢ (ã“ã“ã§ãŠå¥½ã¿ã«èª¿æ•´ã§ãã¾ã™)
    // ==========================================
    
    // å†ç”Ÿæ™‚é–“ã®ç¯„å›²ï¼ˆç§’ï¼‰
    // ã“ã®ç¯„å›²å†…ã§ãƒ©ãƒ³ãƒ€ãƒ ã«æ¬¡ã®å‹•ç”»ã¸é£›ã³ã¾ã™
    const DURATION_MIN = 120; // æœ€çŸ­ 2åˆ† (120ç§’)
    const DURATION_MAX = 180; // æœ€é•· 3åˆ† (180ç§’)

    // è‚Œè‰²æ¢æŸ»ã®è¨­å®š
    const SAMPLE_COUNT = 6;       // 1å‹•ç”»ã‚ãŸã‚Šä½•ç®‡æ‰€ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‹ï¼ˆå¤šã„ã»ã©ç²¾åº¦ã‚¢ãƒƒãƒ—ã€é…ããªã‚‹ï¼‰
    const SEARCH_RANGE_MIN = 0.3; // å‹•ç”»å…¨ä½“ã®30%åœ°ç‚¹ã‹ã‚‰æ¢ç´¢é–‹å§‹
    const SEARCH_RANGE_MAX = 0.9; // å‹•ç”»å…¨ä½“ã®90%åœ°ç‚¹ã¾ã§æ¢ç´¢

    // ==========================================
    //  ä»¥ä¸‹ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ æœ¬ä½“
    // ==========================================

    const video = document.getElementById('mainVideo');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    const controls = document.getElementById('controls');
    const analyzeOverlay = document.getElementById('analyzing-overlay');
    const analyzeText = document.getElementById('analyze-text');
    const skipBtn = document.getElementById('skip-btn');

    let playlist = [];
    let cruiseTimer = null;

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    fileInput.addEventListener('change', function(e) {
        playlist = Array.from(e.target.files);
        if (playlist.length === 0) return;
        
        // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        shuffleArray(playlist);
        
        status.innerText = `${playlist.length} æœ¬ã®å‹•ç”»ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚\nå†ç”Ÿã‚’é–‹å§‹ã—ã¾ã™...`;
        
        // 1ç§’å¾Œã«å†ç”Ÿé–‹å§‹
        setTimeout(() => {
            controls.classList.add('hidden');
            skipBtn.style.display = 'block';
            playNext();
        }, 1000);
    });

    // é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•°
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // æ¬¡ã®å‹•ç”»ã‚’å†ç”Ÿã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
    async function playNext() {
        if (playlist.length === 0) return;
        
        // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
        if (cruiseTimer) clearTimeout(cruiseTimer);

        // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å…ˆé ­ã‚’å–ã‚Šå‡ºã—ã¦æœ«å°¾ã¸ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰
        const currentFile = playlist.shift();
        playlist.push(currentFile);

        // ãƒ•ã‚¡ã‚¤ãƒ«URLç”Ÿæˆ
        const fileURL = URL.createObjectURL(currentFile);
        video.src = fileURL;
        
        // è¡¨ç¤ºæ›´æ–°
        analyzeOverlay.classList.add('show');
        analyzeText.innerText = "Loading Video...";

        // å‹•ç”»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾…ã¡
        video.onloadedmetadata = async () => {
            analyzeText.innerText = "AI Scanning Best Shot...";
            
            // AIãƒ­ã‚¸ãƒƒã‚¯ã§ã€Œç¾å‘³ã—ã„æ™‚é–“ã€ã‚’æ¢ã™
            const bestTime = await findBestClimaxTime(video);
            
            analyzeOverlay.classList.remove('show');
            
            // æ±ºå®šã—ãŸæ™‚é–“ã‹ã‚‰å†ç”Ÿ
            video.currentTime = bestTime;
            
            try {
                await video.play();
            } catch (err) {
                // è‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯å¯¾ç­–ï¼ˆç”»é¢ã‚¿ãƒƒãƒ—ã‚’ä¿ƒã™ï¼‰
                analyzeText.innerText = "Tap screen to start";
                analyzeOverlay.classList.add('show');
            }

            // æ¬¡ã®å‹•ç”»ã¸é£›ã¶ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆ
            setNextTimer();
        };

        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—
        video.onerror = () => { 
            console.log("Video Error, skipping."); 
            playNext(); 
        };
    }

    // ãƒ©ãƒ³ãƒ€ãƒ ãªæ™‚é–“çµŒéå¾Œã«æ¬¡ã¸é£›ã¶ã‚¿ã‚¤ãƒãƒ¼
    function setNextTimer() {
        // è¨­å®šç¯„å›²å†…ã§ãƒ©ãƒ³ãƒ€ãƒ ãªç§’æ•°ã‚’æ±ºå®š
        const nextDuration = Math.random() * (DURATION_MAX - DURATION_MIN) + DURATION_MIN;
        console.log(`Next jump in: ${Math.floor(nextDuration)} sec`);

        cruiseTimer = setTimeout(() => {
            playNext();
        }, nextDuration * 1000);
    }

    // --- è‚Œè‰²åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---

    // æŒ‡å®šæ™‚é–“ã®è‚Œè‰²ç‡ã‚’è¨ˆç®—ã™ã‚‹
    function checkSkinRatioAt(time) {
        return new Promise(resolve => {
            const onSeek = () => {
                video.removeEventListener('seeked', onSeek);
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”» (160x90ã«ç¸®å°ã—ã¦é«˜é€Ÿå‡¦ç†)
                canvas.width = 160; 
                canvas.height = 90;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = frame.data;
                let skinPixels = 0;
                let totalPixels = data.length / 4;

                // å…¨ãƒ”ã‚¯ã‚»ãƒ«èµ°æŸ»
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // è‚Œè‰²åˆ¤å®šæ¡ä»¶ (ç°¡æ˜“ç‰ˆ)
                    // èµ¤æˆåˆ†ãŒå¼·ãã€ã‹ã¤æ˜ã‚‹ã•ãŒä¸€å®šä»¥ä¸Š
                    if (r > 60 && g > 40 && b > 20 && 
                        r > g && r > b && 
                        (Math.max(r,g,b) - Math.min(r,g,b) > 15) &&
                        Math.abs(r - g) > 15) {
                        skinPixels++;
                    }
                }
                
                resolve(skinPixels / totalPixels);
            };

            // ã‚·ãƒ¼ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²å¾Œã«æ™‚é–“ã‚’å¤‰æ›´
            video.addEventListener('seeked', onSeek);
            video.currentTime = time;
        });
    }

    // è¤‡æ•°ã®å€™è£œåœ°ç‚¹ã‚’æ¯”è¼ƒã—ã¦ãƒ™ã‚¹ãƒˆãªæ™‚é–“ã‚’è¿”ã™
    async function findBestClimaxTime(vid) {
        const duration = vid.duration;
        
        // å‹•ç”»ãŒçŸ­ã„(2åˆ†ä»¥ä¸‹)ãªã‚‰å†’é ­ã‹ã‚‰å†ç”Ÿ
        if (duration < 120) return 0;

        const minTime = duration * SEARCH_RANGE_MIN;
        const maxTime = duration * SEARCH_RANGE_MAX;

        let bestTime = minTime;
        let maxScore = -1;

        // å€™è£œæ™‚é–“ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
        const candidates = [];
        for(let i=0; i<SAMPLE_COUNT; i++) {
            candidates.push(Math.random() * (maxTime - minTime) + minTime);
        }

        // è§£æä¸­ã¯éŸ³ã‚’æ¶ˆã™
        const originalMuted = vid.muted;
        vid.muted = true;

        // å€™è£œåœ°ç‚¹ã‚’é †ç•ªã«ãƒã‚§ãƒƒã‚¯
        for (let time of candidates) {
            const score = await checkSkinRatioAt(time);
            // console.log(`Time: ${Math.floor(time/60)}m, Score: ${(score*100).toFixed(1)}%`);
            
            if (score > maxScore) {
                maxScore = score;
                bestTime = time;
            }
        }

        // éŸ³å£°ã‚’æˆ»ã™
        vid.muted = originalMuted;
        
        // ãƒ™ã‚¹ãƒˆåœ°ç‚¹ã®15ç§’å‰ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã„ããªã‚Šæ ¸å¿ƒã§ãªãæ–‡è„ˆã‚’æŒãŸã›ã‚‹ï¼‰
        return Math.max(0, bestTime - 15);
    }

    // ç”»é¢ã‚¿ãƒƒãƒ—ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ‡æ›¿
    document.body.addEventListener('click', (e) => {
        // ãƒœã‚¿ãƒ³ã‚„å…¥åŠ›æ¬„ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
        if(e.target === skipBtn || e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;
        
        // AIè§£æä¸­ã§ãªã‘ã‚Œã°ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
        if (!analyzeOverlay.classList.contains('show')) {
            controls.classList.toggle('hidden');
        }
    });

</script>
</body>
</html>
