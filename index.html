<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AV Cockpit Rhythm Final</title>
<style>
    /* === „Éá„Ç∂„Ç§„É≥Ë®≠ÂÆö === */
    :root {
        --bg-main: #050008;
        --panel-bg: #100508;
        --neon-pink: #ff0055;
        --neon-blue: #00d2ff;
        --neon-green: #00ff99;
        --text-color: #eee;
    }
    body { background: var(--bg-main); margin: 0; overflow: hidden; font-family: 'Courier New', sans-serif; color: var(--text-color); user-select: none; }
    
    #container { display: flex; width: 100vw; height: 100vh; }

    /* Â∑¶ÂÅ¥ÔºöÂãïÁîª„Çπ„ÉÜ„Éº„Ç∏ */
    #video-stage {
        flex: 1; position: relative; background: #000; overflow: hidden;
        border-right: 4px solid var(--neon-pink);
        box-shadow: 0 0 20px rgba(255, 0, 85, 0.3);
    }
    video { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
    
    /* „Ç¨„Ç§„ÉâË°®Á§∫ */
    .overlay-guide {
        position: absolute; bottom: 20px; left: 0; width: 100%; 
        text-align: center; color: rgba(255,255,255,0.4); font-size: 12px; pointer-events: none;
        text-shadow: 0 0 5px #000;
    }

    /* Âè≥ÂÅ¥Ôºö„Ç≥„ÇØ„Éî„ÉÉ„Éà„Éë„Éç„É´ */
    #cockpit-panel {
        width: 340px; background: var(--panel-bg);
        display: flex; flex-direction: column;
        padding: 10px; box-sizing: border-box;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 50;
    }

    .panel-section {
        margin-bottom: 10px; border: 1px solid var(--neon-blue);
        background: rgba(0, 20, 30, 0.6); padding: 8px; border-radius: 6px;
        position: relative;
    }
    .title { font-size: 11px; color: var(--neon-blue); margin-bottom: 5px; letter-spacing: 1px; font-weight: bold; }

    /* UI„Éú„Çø„É≥ */
    .btn-group { display: flex; gap: 5px; }
    .btn {
        flex: 1; background: #222; border: 1px solid var(--neon-blue); color: #fff;
        padding: 10px 0; border-radius: 4px; font-weight: bold; cursor: pointer; text-align: center;
        transition: all 0.1s; font-size: 13px;
    }
    .btn-main { background: linear-gradient(135deg, var(--neon-pink), #aa0033); border: none; box-shadow: 0 0 10px var(--neon-pink); }
    .btn-skip { background: #004455; border-color: var(--neon-blue); color: var(--neon-blue); }
    .btn:active { transform: scale(0.96); filter: brightness(1.2); }
    input[type="file"] { display: none; }

    /* „É°„Éº„Çø„ÉºÈ°û */
    #bpm-display { 
        font-size: 24px; font-weight: bold; text-align: center; margin: 5px 0; 
        color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green);
    }
    #bpm-sub { font-size: 10px; text-align: center; color: #888; }

    /* „Éí„Éº„Éà„Ç≤„Éº„Ç∏ */
    .heat-container { width: 100%; height: 6px; background: #333; margin-top: 5px; border-radius: 3px; overflow: hidden; }
    #heat-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink)); transition: width 0.1s; }

    /* Ê®™„Çπ„ÇØ„É≠„Éº„É´„Éª„Éé„Éº„ÉÑ„É¨„Éº„É≥ */
    #notes-lane-wrap {
        flex: 1; position: relative; overflow: hidden;
        background: linear-gradient(90deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 100%);
        border-top: 2px solid var(--neon-blue);
        border-bottom: 2px solid var(--neon-blue);
        margin-bottom: 10px;
    }
    #notes-canvas { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; }
    
    /* Âà§ÂÆö„É©„Ç§„É≥ÔºàÂ∑¶ÂÅ¥„Å´Á∏¶Á∑öÔºâ */
    #hit-line {
        position: absolute; top: 0; left: 60px; width: 4px; height: 100%;
        background: rgba(255, 255, 255, 0.6); z-index: 5;
        box-shadow: 0 0 15px #fff;
    }

    /* „Çπ„Éö„ÇØ„Éà„É©„É† */
    #spectrum-wrap {
        height: 80px; position: relative; background: #000;
        border: 1px solid #444; overflow: hidden;
    }
    #spectrum-canvas { width: 100%; height: 100%; }

    /* ÂàùÊúü„É≠„Éº„ÉâÁîªÈù¢ */
    #init-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
        background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .start-btn {
        padding: 20px 60px; font-size: 24px; border-radius: 50px; margin-top: 30px; cursor: pointer;
        background: var(--neon-pink); color: #fff; font-weight: bold; border: 2px solid #fff;
        box-shadow: 0 0 30px var(--neon-pink); animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
</style>
</head>
<body>

<div id="container">
    <div id="video-stage">
        <video id="mainVideo" playsinline crossorigin="anonymous"></video>
        <div class="overlay-guide">Double Tap Video to Fullscreen Mode</div>
    </div>

    <div id="cockpit-panel">
        
        <div class="panel-section">
            <div class="title">SYSTEM CONTROL</div>
            <div class="btn-group">
                <label class="btn btn-main">
                    üìÇ ADD FILES
                    <input type="file" id="subFileInput" multiple accept="video/*">
                </label>
                <button class="btn btn-skip" onclick="manualSkip()">SKIP ‚è≠</button>
            </div>
        </div>

        <div class="panel-section">
            <div class="title">ENGINE HEAT (INERTIA)</div>
            <div id="bpm-display">IDLE</div>
            <div id="bpm-sub">WAITING INPUT...</div>
            <div class="heat-container">
                <div id="heat-bar"></div>
            </div>
        </div>

        <div class="panel-section" style="flex:1; display:flex; flex-direction:column; padding:0; border:none; background:none;">
            <div class="title" style="padding-left:5px;">RHYTHM FLOW &gt;&gt;&gt;</div>
            <div id="notes-lane-wrap">
                <div id="hit-line"></div>
                <canvas id="notes-canvas"></canvas>
            </div>
        </div>

        <div class="panel-section" style="padding:5px;">
            <div class="title">AUDIO VISUALIZER</div>
            <div id="spectrum-wrap">
                <canvas id="spectrum-canvas"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="init-screen">
    <h1 style="color:var(--neon-pink); text-shadow:0 0 20px var(--neon-pink); font-size:40px; margin:0;">AV COCKPIT</h1>
    <div style="color:var(--neon-blue); letter-spacing:4px; margin-bottom:20px;">FINAL EDITION</div>
    
    <label class="start-btn">
        üöÄ LAUNCH SYSTEM
        <input type="file" id="mainFileInput" multiple accept="video/*">
    </label>
</div>

<script>
// === Ë®≠ÂÆö„Éë„É©„É°„Éº„Çø ===
    const INTERVAL_SLOW = 4000; // ÊúÄ„ÇÇÈÅÖ„ÅÑÈñìÈöî
    const INTERVAL_FAST = 450;  // ÊúÄ„ÇÇÈÄü„ÅÑÈñìÈöî
    const NOTE_SPEED = 6;       // „Éé„Éº„ÉÑÈÄüÂ∫¶
    const HIT_X = 60;           // Âà§ÂÆö„É©„Ç§„É≥X

    // === Â§âÊï∞ ===
    const video = document.getElementById('mainVideo');
    const notesCanvas = document.getElementById('notes-canvas');
    const specCanvas = document.getElementById('spectrum-canvas');
    const nCtx = notesCanvas.getContext('2d');
    const sCtx = specCanvas.getContext('2d');
    
    const bpmDisplay = document.getElementById('bpm-display');
    const bpmSub = document.getElementById('bpm-sub');
    const heatBar = document.getElementById('heat-bar');
    const initScreen = document.getElementById('init-screen');

    let playlist = [];
    let audioCtx, analyser;
    let notes = [];
    let cruiseTimer = null;
    let nextNoteTime = 0;
    
    // ‚òÖÊñ∞„É≠„Ç∏„ÉÉ„ÇØÁî®Â§âÊï∞
    let currentHeat = 0;      // Ë°®Á§∫‰∏ä„ÅÆ„É¨„Éô„É´ (0.0~1.0)
    let avgEnergy = 0;        // Áõ¥Ëøë„ÅÆÂπ≥ÂùáÈü≥Èáè
    let peakEnergy = 100;     // Áõ¥Ëøë„ÅÆÊúÄÂ§ßÈü≥ÈáèÔºàÊ≠£Ë¶èÂåñÁî®Ôºâ

    // === „Ç§„Éô„É≥„ÉàË®≠ÂÆö ===
    document.getElementById('mainFileInput').addEventListener('change', handleFileSelect);
    document.getElementById('subFileInput').addEventListener('change', handleFileSelect);
    
    // „ÉÄ„Éñ„É´„Çø„ÉÉ„ÉóÂÖ®ÁîªÈù¢
    let lastTap = 0;
    document.getElementById('video-stage').addEventListener('click', () => {
        const now = new Date().getTime();
        if (now - lastTap < 300) {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
            else if (document.exitFullscreen) document.exitFullscreen();
        }
        lastTap = now;
    });

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        playlist = playlist.concat(files);
        shuffleArray(playlist);
        initAudio(); 
        if (initScreen.style.display !== 'none') {
            initScreen.style.display = 'none';
            playNext();
            requestAnimationFrame(renderLoop);
        }
    }

    function initAudio() {
        if(audioCtx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.8; 
        const source = audioCtx.createMediaElementSource(video);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function playNext() {
        if(playlist.length === 0) return;
        if(cruiseTimer) clearTimeout(cruiseTimer);
        const file = playlist.shift();
        playlist.push(file);

        video.src = URL.createObjectURL(file);
        video.play().catch(()=>{});
        
        // ÂãïÁîªÂ§âÊõ¥ÊôÇ„É™„Çª„ÉÉ„Éà
        video.onloadedmetadata = () => { 
            video.currentTime = video.duration * (0.3 + Math.random() * 0.4); 
            // Âπ≥ÂùáÂÄ§„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶Êñ∞„Åó„ÅÑÂãïÁîª„Å´È¶¥Êüì„Åæ„Åõ„Çã
            avgEnergy = 0; 
            peakEnergy = 100;
        };
        
        const duration = (180 + Math.random() * 120) * 1000;
        cruiseTimer = setTimeout(playNext, duration);
    }
    
    function manualSkip() { playNext(); }

    // === „É°„Ç§„É≥„É´„Éº„Éó ===
    function renderLoop() {
        requestAnimationFrame(renderLoop);
        if(!analyser) return;

        syncCanvas(notesCanvas);
        syncCanvas(specCanvas);

        // 1. „Ç™„Éº„Éá„Ç£„Ç™Ëß£Êûê
        const bufferLen = analyser.frequencyBinCount;
        const data = new Uint8Array(bufferLen);
        analyser.getByteFrequencyData(data);
        drawSpectrum(data, bufferLen);

        // „Ç®„Éç„É´„ÇÆ„ÉºË®àÁÆó (‰ΩéÈü≥„Äú‰∏≠Èü≥ÈáçË¶ñ)
        let rawEnergy = 0;
        const range = Math.floor(bufferLen * 0.5);
        for(let i=0; i<range; i++) rawEnergy += data[i];
        rawEnergy = rawEnergy / range; // 0„Äú255

        // ‚òÖÊñ∞„É≠„Ç∏„ÉÉ„ÇØ: Áõ∏ÂØæË©ï‰æ°„Ç∑„Çπ„ÉÜ„É†‚òÖ
        
        // Âπ≥ÂùáÈü≥Èáè„ÅÆÊõ¥Êñ∞ („ÇÜ„Å£„Åè„ÇäËøΩÂæì)
        if (rawEnergy > 0) {
            if (avgEnergy === 0) avgEnergy = rawEnergy;
            else avgEnergy = avgEnergy * 0.98 + rawEnergy * 0.02;
        }

        // „Éî„Éº„ÇØÈü≥Èáè„ÅÆÊõ¥Êñ∞ („ÇÜ„Å£„Åè„Çä‰∏ã„Åå„Çã)
        if (rawEnergy > peakEnergy) peakEnergy = rawEnergy;
        else peakEnergy -= 0.1;
        if (peakEnergy < 50) peakEnergy = 50; // ÊúÄ‰Ωé‰øùË®º

        // „Äå‰ªä„ÅÆÈü≥„ÅåÂπ≥Âùá„Çà„Çä„Å©„Çå„Å†„ÅëÂ§ß„Åç„ÅÑ„Åã„Äç„ÇíË®àÁÆó
        // Âπ≥Âùá„Å®Âêå„Åò„Å™„Çâ delta = 0, Âπ≥Âùá„ÅÆ1.5ÂÄç„Å™„Çâ delta = È´ò„ÅÑ
        let delta = rawEnergy - avgEnergy;
        
        // Ê≠£Ë¶èÂåñ (-20 „Äú +50 „Åè„Çâ„ÅÑ„ÅÆÂπÖ„Çí 0.0„Äú1.0„Å´„Åô„Çã„Ç§„É°„Éº„Ç∏)
        // avgEnergy„ÅåÈ´ò„Åè„Å¶„ÇÇ„ÄÅdelta„ÅåÂ∞è„Åï„Åë„Çå„Å∞Heat„ÅØ‰∏ä„Åå„Çâ„Å™„ÅÑ
        let targetHeat = 0;
        
        if (delta > 5) {
            // Âπ≥Âùá„Çà„ÇäÊòéÁ¢∫„Å´Â§ß„Åç„ÅÑÊôÇ„Å†„Åë„Éí„Éº„Éà„Ç¢„ÉÉ„Éó
            targetHeat = delta / (peakEnergy * 0.4); // „Éî„Éº„ÇØ„ÅÆ4Ââ≤„Åè„Çâ„ÅÑ„ÅÆÂ§âÂãïÂπÖ„Åå„ÅÇ„Çå„Å∞MAX
        } else {
            // Âπ≥Âùá‰ª•‰∏ã„Å™„Çâ„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥
            targetHeat = 0;
        }
        
        // „ÇØ„É©„É≥„Éó
        if(targetHeat > 1.0) targetHeat = 1.0;
        if(targetHeat < 0) targetHeat = 0;

        // ÊÖ£ÊÄß„Çí„Å§„Åë„Å¶ currentHeat „Çí targetHeat „Å´Ëøë„Å•„Åë„Çã
        // ‰∏ä„Åå„Çã„ÅÆ„ÅØÊó©„Åè„ÄÅ‰∏ã„Åå„Çã„ÅÆ„ÅØ„ÇÜ„Å£„Åè„Çä
        if (targetHeat > currentHeat) {
            currentHeat = currentHeat * 0.9 + targetHeat * 0.1;
        } else {
            currentHeat = currentHeat * 0.98 + targetHeat * 0.02;
        }

        // „Éí„Éº„Éà„Éê„ÉºÊõ¥Êñ∞
        heatBar.style.width = (currentHeat * 100) + "%";
        
        // „Éí„Éº„ÉàÂÄ§„Åã„Çâ„Ç§„É≥„Çø„Éº„Éê„É´Ë®àÁÆó
        const currentInterval = INTERVAL_SLOW - (currentHeat * (INTERVAL_SLOW - INTERVAL_FAST));

        // Ë°®Á§∫Êõ¥Êñ∞
        const percent = Math.round(currentHeat * 100);
        bpmDisplay.innerText = `Lv.${percent}`;
        bpmSub.innerText = `${(currentInterval/1000).toFixed(2)}s`;
        
        const hue = 180 + (currentHeat * 180);
        bpmDisplay.style.color = `hsl(${hue}, 100%, 60%)`;
        heatBar.style.background = `hsl(${hue}, 100%, 60%)`;

        // „Éé„Éº„ÉÑÁîüÊàê
        const now = Date.now();
        if (now > nextNoteTime) {
            spawnNote(currentHeat, hue);
            nextNoteTime = now + currentInterval;
        }

        drawNotes();
    }

    function syncCanvas(cvs) {
        const p = cvs.parentElement;
        if (cvs.width !== p.clientWidth || cvs.height !== p.clientHeight) {
            cvs.width = p.clientWidth;
            cvs.height = p.clientHeight;
        }
    }

    function drawSpectrum(data, bufferLen) {
        const W = specCanvas.width; const H = specCanvas.height;
        sCtx.clearRect(0, 0, W, H);
        const barW = (W / bufferLen) * 2.5;
        let x = 0;
        for(let i = 0; i < bufferLen; i++) {
            const barH = (data[i] / 255) * H;
            const hue = (i / bufferLen) * 360;
            sCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            sCtx.fillRect(x, H - barH, barW, barH);
            x += barW + 1;
            if(x > W) break;
        }
    }

    function spawnNote(heat, hue) {
        const H = notesCanvas.height;
        let height = H * (0.3 + (heat * 0.6)); 
        notes.push({
            x: notesCanvas.width + 50,
            y: (H - height) / 2,
            width: 20,
            height: height,
            color: `hsl(${hue}, 100%, 60%)`,
            glow: heat * 20
        });
    }

    function drawNotes() {
        const W = notesCanvas.width; const H = notesCanvas.height;
        nCtx.clearRect(0, 0, W, H);
        const line = document.getElementById('hit-line');

        for (let i = notes.length - 1; i >= 0; i--) {
            const n = notes[i];
            n.x -= NOTE_SPEED;

            nCtx.shadowBlur = 10 + n.glow;
            nCtx.shadowColor = n.color;
            nCtx.fillStyle = n.color;
            nCtx.globalAlpha = 0.9;
            nCtx.beginPath();
            nCtx.roundRect(n.x, n.y, n.width, n.height, 4);
            nCtx.fill();

            if (n.x < HIT_X && n.x > HIT_X - NOTE_SPEED - 5) {
                line.style.background = n.color;
                line.style.boxShadow = `0 0 30px ${n.color}`;
                setTimeout(() => {
                    line.style.background = 'rgba(255,255,255,0.6)';
                    line.style.boxShadow = '0 0 15px #fff';
                }, 100);
            }
            if (n.x < -50) notes.splice(i, 1);
        }
        nCtx.shadowBlur = 0;
    }
</script>
</body>
</html>
