<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AV Adaptive Metronome</title>
<style>
    body { background: #000; margin: 0; overflow: hidden; font-family: sans-serif; color: #fff; }
    
    #stage { 
        position: relative; width: 100vw; height: 100vh; 
        display: flex; justify-content: center; align-items: center;
        background: #000;
    }
    
    video { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        object-fit: contain; opacity: 0.6;
    }

    canvas { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 10; pointer-events: none; 
    }

    #hit-line {
        position: absolute; bottom: 15%; left: 0; width: 100%; height: 4px;
        background: rgba(255, 255, 255, 0.2); z-index: 5;
        box-shadow: 0 0 5px rgba(255,255,255,0.3);
    }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°å…¼ï¼‰ */
    #status-overlay {
        position: absolute; top: 10px; left: 10px; z-index: 20;
        font-size: 10px; color: #00ff00; font-family: monospace;
        background: rgba(0,0,0,0.5); padding: 5px; pointer-events: none;
    }

    /* é€Ÿåº¦ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
    #bpm-indicator {
        position: absolute; bottom: 17%; right: 10px; 
        font-size: 16px; font-weight: bold; color: #00d2ff;
        text-shadow: 0 0 5px #000; z-index: 20;
        text-align: right;
    }

    #ui-panel {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    #ui-panel.hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s; }

    .file-btn {
        background: linear-gradient(135deg, #00d2ff, #3a7bd5);
        border: 1px solid #00d2ff;
        color: white; padding: 15px 40px; border-radius: 50px; 
        font-weight: bold; font-size: 18px; cursor: pointer; margin-bottom: 20px;
        box-shadow: 0 0 15px #00d2ff;
    }
    input[type="file"] { display: none; }
    
    #skip-btn {
        position: absolute; top: 20px; right: 20px; z-index: 50;
        background: rgba(255,255,255,0.2); border: 1px solid #fff; color: #fff;
        width: 60px; height: 60px; border-radius: 50%; cursor: pointer; display: none;
    }
</style>
</head>
<body>

<div id="stage">
    <video id="mainVideo" playsinline crossorigin="anonymous"></video>
    <div id="hit-line"></div>
    <canvas id="visualizer"></canvas>
    
    <div id="status-overlay">
        Adaptive Gain Control:<br>
        Cur: <span id="debug-cur">0</span><br>
        Min: <span id="debug-min">0</span><br>
        Max: <span id="debug-max">0</span>
    </div>

    <div id="bpm-indicator">INITIALIZING...</div>
    <button id="skip-btn" onclick="playNext()">SKIP</button>
</div>

<div id="ui-panel">
    <h1 style="color:#00d2ff; text-shadow:0 0 10px #00d2ff;">ADAPTIVE RHYTHM</h1>
    <label class="file-btn">
        ğŸ“‚ å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ
        <input type="file" id="fileInput" multiple accept="video/*">
    </label>
    <div style="color:#aaa; font-size:12px; margin-top:10px;">
        Auto-Normalizing Volume<br>
        Slow: 5000ms <-> Fast: 500ms
    </div>
</div>

<script>
    // === è¨­å®š ===
    const INTERVAL_SLOW = 5000; // æœ€é… (ms)
    const INTERVAL_FAST = 500;  // æœ€é€Ÿ (ms)
    const NOTE_FALL_SPEED = 8;
    
    // ã‚¯ãƒ«ãƒ¼ã‚ºè¨­å®š
    const CRUISE_MIN_SEC = 120; // 2åˆ†
    const CRUISE_MAX_SEC = 240; // 4åˆ†

    // === ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•° ===
    const video = document.getElementById('mainVideo');
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    const bpmText = document.getElementById('bpm-indicator');
    
    // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºç”¨
    const dbgCur = document.getElementById('debug-cur');
    const dbgMin = document.getElementById('debug-min');
    const dbgMax = document.getElementById('debug-max');

    let playlist = [];
    let audioCtx, analyser, sourceNode;
    let notes = [];
    let cruiseTimer = null;

    // ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ åˆ¶å¾¡
    let nextNoteTime = 0;
    let currentInterval = 2000;

    // â˜…è‡ªå‹•æ­£è¦åŒ–ç”¨ã®å¤‰æ•°â˜…
    let dynamicMin = 255; // åˆæœŸå€¤ã¯é€†ã«è¨­å®šã—ã¦ã™ãä¸Šæ›¸ãã•ã›ã‚‹
    let dynamicMax = 0;
    
    // åˆæœŸåŒ–
    document.getElementById('fileInput').addEventListener('change', (e) => {
        playlist = Array.from(e.target.files);
        if (playlist.length === 0) return;
        shuffleArray(playlist);
        initAudio();

        document.getElementById('ui-panel').classList.add('hidden');
        document.getElementById('skip-btn').style.display = 'block';
        
        playNext();
        requestAnimationFrame(renderLoop);
    });

    function initAudio() {
        if(audioCtx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.8; 
        sourceNode = audioCtx.createMediaElementSource(video);
        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function playNext() {
        if(playlist.length === 0) return;
        if(cruiseTimer) clearTimeout(cruiseTimer);

        const file = playlist.shift();
        playlist.push(file);

        // å‹•ç”»åˆ‡ã‚Šæ›¿ãˆæ™‚ã« Min/Max ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ–°ã—ã„å‹•ç”»ã®éŸ³é‡ã«åˆã‚ã›ã‚‹ãŸã‚ï¼‰
        dynamicMin = 100; // é©å½“ãªä¸­é–“å€¤ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        dynamicMax = 150; 
        currentInterval = 2000;

        video.src = URL.createObjectURL(file);
        video.play().catch(()=>{});

        // æœ¬ç•ªç®‡æ‰€ã¸ã‚¸ãƒ£ãƒ³ãƒ— (30%ã€œ80%)
        video.onloadedmetadata = () => {
             video.currentTime = video.duration * (0.3 + Math.random() * 0.5);
        };

        const duration = (CRUISE_MIN_SEC + Math.random() * (CRUISE_MAX_SEC - CRUISE_MIN_SEC)) * 1000;
        cruiseTimer = setTimeout(playNext, duration);
    }

    function renderLoop() {
        requestAnimationFrame(renderLoop);
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const W = canvas.width;
        const H = canvas.height;
        const hitY = H * 0.85;

        ctx.clearRect(0, 0, W, H);
        if(!analyser) return;

        // 1. ç¾åœ¨ã®éŸ³é‡ã‚¨ãƒãƒ«ã‚®ãƒ¼å–å¾— (0-255)
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        let energy = 0;
        // ä½éŸ³ã€œä¸­éŸ³åŸŸ (å£°ã®å¸¯åŸŸ) ã‚’é‡ç‚¹è©•ä¾¡
        const range = Math.floor(bufferLength * 0.6); 
        for(let i = 0; i < range; i++) {
            energy += dataArray[i];
        }
        energy = energy / range;

        // â˜…è‡ªå‹•æ­£è¦åŒ–ãƒ­ã‚¸ãƒƒã‚¯ (Adaptive Gain Control)â˜…
        
        // æ¥µç«¯ãªé™å¯‚(ãƒã‚¤ã‚º)ã¯ç„¡è¦–
        if (energy > 5) {
            // Min/Maxã®æ›´æ–°
            // æ€¥æ¿€ã«åºƒãŒã‚‹ãŒã€ã‚†ã£ãã‚Šç‹­ã¾ã‚‹ï¼ˆã‚·ãƒ¼ãƒ³è»¢æ›ã¸ã®è¿½å¾“ï¼‰
            if (energy < dynamicMin) dynamicMin = energy;
            else dynamicMin += 0.05; // ã‚†ã£ãã‚Šä¸Šæ˜‡ã•ã›ã¦ã€Œä»Šã®é™å¯‚ã€ã«åˆã‚ã›ã‚‹

            if (energy > dynamicMax) dynamicMax = energy;
            else dynamicMax -= 0.1;  // ã‚†ã£ãã‚Šä¸‹é™ã•ã›ã¦ã€Œä»Šã®æœ€å¤§ã€ã«åˆã‚ã›ã‚‹
            
            // å®‰å…¨è£…ç½®ï¼ˆMinã¨MaxãŒè¿‘ã¥ãã™ããªã„ã‚ˆã†ã«ï¼‰
            if (dynamicMax - dynamicMin < 20) dynamicMax = dynamicMin + 20;
        }

        // 2. æ­£è¦åŒ– (0.0 ã€œ 1.0) ã®è¨ˆç®—
        // ä»Šã®éŸ³ãŒã€ç¾åœ¨ã®Min-Maxãƒ¬ãƒ³ã‚¸ã®ã©ã“ã«ã„ã‚‹ã‹ï¼Ÿ
        let ratio = (energy - dynamicMin) / (dynamicMax - dynamicMin);
        
        // ã‚¯ãƒ©ãƒ³ãƒ—å‡¦ç†
        if (ratio < 0) ratio = 0;
        if (ratio > 1) ratio = 1;

        // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
        dbgCur.innerText = energy.toFixed(1);
        dbgMin.innerText = dynamicMin.toFixed(1);
        dbgMax.innerText = dynamicMax.toFixed(1);

        // 3. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨ˆç®—
        const targetInterval = INTERVAL_SLOW - (ratio * (INTERVAL_SLOW - INTERVAL_FAST));
        
        // å¤‰åŒ–ã‚’ãªã‚ã‚‰ã‹ã«
        currentInterval = currentInterval * 0.9 + targetInterval * 0.1;

        // UIè¡¨ç¤º
        const percent = Math.round(ratio * 100);
        bpmText.innerHTML = `<span style="font-size:0.7em">INT:</span> ${(currentInterval/1000).toFixed(2)}s<br>LV: ${percent}%`;
        
        // è‰²ã‚’å¤‰ãˆã‚‹
        const hue = 200 + (ratio * 160); // é’(200) -> èµ¤(360)
        bpmText.style.color = `hsl(${hue}, 100%, 70%)`;

        // 4. ãƒãƒ¼ãƒ„ç”Ÿæˆ
        const now = Date.now();
        if (now > nextNoteTime) {
            spawnNote(ratio, W, hue);
            nextNoteTime = now + currentInterval;
        }

        updateNotes(W, H, hitY);
    }

    function spawnNote(ratio, screenW, hue) {
        // æ­£è¦åŒ–ã•ã‚ŒãŸ ratio (0.0~1.0) ã«åŸºã¥ã„ã¦è¦‹ãŸç›®ã‚’æ±ºå®š
        // ã“ã‚Œã«ã‚ˆã‚Šã€Œç›¸å¯¾çš„ã«æ¿€ã—ã„ã‚·ãƒ¼ãƒ³ã€ã¯å¿…ãšèµ¤ãå¤ªããªã‚‹
        
        let width = screenW * (0.3 + (ratio * 0.6)); // 30% ã€œ 90% å¹…
        let color = `hsl(${hue}, 100%, 50%)`;

        notes.push({
            y: -50,
            color: color,
            width: width,
            shadow: ratio * 40
        });
    }

    function updateNotes(W, H, hitY) {
        for (let i = notes.length - 1; i >= 0; i--) {
            const n = notes[i];
            n.y += NOTE_FALL_SPEED;

            ctx.shadowBlur = 10 + n.shadow;
            ctx.shadowColor = n.color;
            ctx.fillStyle = n.color;
            ctx.globalAlpha = 0.8;
            
            const x = (W - n.width) / 2;
            ctx.beginPath();
            ctx.roundRect(x, n.y, n.width, 15, 8);
            ctx.fill();

            if (n.y > hitY && n.y < hitY + NOTE_FALL_SPEED + 5) {
                const line = document.getElementById('hit-line');
                line.style.background = n.color;
                line.style.boxShadow = `0 0 40px ${n.color}`;
                setTimeout(() => {
                    line.style.background = 'rgba(255,255,255,0.2)';
                    line.style.boxShadow = '0 0 5px rgba(255,255,255,0.3)';
                }, 100);
            }

            if (n.y > H) notes.splice(i, 1);
        }
        ctx.shadowBlur = 0;
    }
</script>
</body>
</html>
