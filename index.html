<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AV Cockpit Rhythm</title>
<style>
    /* === ãƒã‚ªãƒ³ãƒ»ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š === */
    :root {
        --bg-main: #050008;
        --panel-bg: rgba(20, 0, 10, 0.9);
        --neon-pink: #ff0055;
        --neon-blue: #00d2ff;
        --text-color: #eee;
    }
    body { background: var(--bg-main); margin: 0; overflow: hidden; font-family: 'Courier New', sans-serif; color: var(--text-color); }
    
    /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå·¦å³åˆ†å‰²ï¼‰ */
    #container {
        display: flex; width: 100vw; height: 100vh;
    }

    /* å·¦å´ï¼šå‹•ç”»ã‚¨ãƒªã‚¢ */
    #video-stage {
        flex: 1; position: relative; background: #000; overflow: hidden;
        border-right: 3px solid var(--neon-pink);
        box-shadow: 0 0 20px var(--neon-pink);
    }
    video { width: 100%; height: 100%; object-fit: contain; }

    /* å³å´ï¼šã‚³ã‚¯ãƒ”ãƒƒãƒˆãƒ‘ãƒãƒ« */
    #cockpit-panel {
        width: 320px; background: var(--panel-bg);
        display: flex; flex-direction: column;
        padding: 15px; box-sizing: border-box;
        border-left: 2px solid rgba(255, 0, 85, 0.3);
    }

    /* ãƒ‘ãƒãƒ«å†…ã®å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .panel-section {
        margin-bottom: 15px; border: 1px solid var(--neon-blue);
        background: rgba(0, 20, 30, 0.5); padding: 10px; border-radius: 8px;
        position: relative;
    }
    .section-title {
        font-size: 12px; color: var(--neon-blue); margin-bottom: 5px;
        text-transform: uppercase; letter-spacing: 1px;
    }

    /* 1. ä¸Šéƒ¨UI */
    .file-btn {
        background: linear-gradient(45deg, var(--neon-pink), #5500ff);
        border: 1px solid var(--text-color);
        color: white; padding: 10px; border-radius: 4px; 
        font-weight: bold; font-size: 14px; cursor: pointer; display: block; text-align: center;
        box-shadow: 0 0 10px var(--neon-pink); text-shadow: 0 0 5px #fff;
    }
    input[type="file"] { display: none; }
    
    #bpm-meter { font-size: 20px; font-weight: bold; color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink); text-align: center; }
    #bpm-label { font-size: 10px; color: #aaa; text-align: center; }

    /* 2. ä¸­å¤®ï¼šãƒãƒ¼ãƒ„è½ä¸‹ãƒ¬ãƒ¼ãƒ³ */
    #notes-lane-wrap {
        flex: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’å æœ‰ */
        position: relative; overflow: hidden;
        border: 2px solid var(--neon-blue);
        background: rgba(0,0,0,0.3);
        box-shadow: inset 0 0 20px var(--neon-blue);
    }
    #notes-canvas { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; }
    #hit-line {
        position: absolute; bottom: 20%; left: 0; width: 100%; height: 4px;
        background: rgba(255, 255, 255, 0.5); z-index: 5;
        box-shadow: 0 0 15px #fff, 0 0 5px var(--neon-blue);
    }

    /* 3. ä¸‹éƒ¨ï¼šã‚¹ãƒšã‚¯ãƒˆãƒ©ãƒ ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ */
    #spectrum-wrap {
        height: 150px; position: relative;
        border: 2px solid var(--neon-pink); overflow: hidden;
        background: #000;
        box-shadow: inset 0 0 15px var(--neon-pink);
    }
    #spectrum-canvas { position: absolute; top:0; left:0; width:100%; height:100%; }
    
    /* åˆæœŸã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #init-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
        background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
</style>
</head>
<body>

<div id="container">
    <div id="video-stage">
        <video id="mainVideo" playsinline crossorigin="anonymous"></video>
    </div>

    <div id="cockpit-panel">
        
        <div class="panel-section">
            <div class="section-title">System Control</div>
            <label class="file-btn">
                ğŸ“‚ LOAD FOLDER
                <input type="file" id="fileInput" multiple accept="video/*">
            </label>
        </div>

        <div class="panel-section">
            <div class="section-title">Rhythm Engine</div>
            <div id="bpm-meter">READY</div>
            <div id="bpm-label">INTERVAL TIME</div>
        </div>

        <div class="panel-section" style="flex:1; display:flex; flex-direction:column; padding:5px;">
            <div class="section-title">STROKE GUIDE</div>
            <div id="notes-lane-wrap">
                <div id="hit-line"></div>
                <canvas id="notes-canvas"></canvas>
            </div>
        </div>

        <div class="panel-section" style="padding:5px;">
            <div class="section-title">AUDIO SPECTRUM</div>
            <div id="spectrum-wrap">
                <canvas id="spectrum-canvas"></canvas>
            </div>
        </div>

    </div>
</div>

<div id="init-overlay">
    <h1 style="color:var(--neon-pink); text-shadow:0 0 20px var(--neon-pink);">AV COCKPIT RHYTHM</h1>
    <p>Please load video folder from the right panel.</p>
</div>

<script>
    // === è¨­å®š ===
    const INTERVAL_SLOW = 5000; const INTERVAL_FAST = 500;
    const NOTE_FALL_SPEED = 6;
    const CRUISE_MIN_SEC = 120; const CRUISE_MAX_SEC = 240;

    // === DOM ===
    const video = document.getElementById('mainVideo');
    const notesCanvas = document.getElementById('notes-canvas');
    const specCanvas = document.getElementById('spectrum-canvas');
    const nCtx = notesCanvas.getContext('2d');
    const sCtx = specCanvas.getContext('2d');
    const bpmMeter = document.getElementById('bpm-meter');
    const initOverlay = document.getElementById('init-overlay');

    // === å¤‰æ•° ===
    let playlist = [];
    let audioCtx, analyser, sourceNode;
    let notes = [];
    let cruiseTimer = null;
    let nextNoteTime = 0;
    let currentInterval = 2000;
    // è‡ªå‹•æ­£è¦åŒ–ç”¨
    let dynamicMin = 100; let dynamicMax = 150;

    // === åˆæœŸåŒ– ===
    document.getElementById('fileInput').addEventListener('change', (e) => {
        playlist = Array.from(e.target.files);
        if (playlist.length === 0) return;
        shuffleArray(playlist);
        initAudio();
        initOverlay.style.display = 'none';
        playNext();
        requestAnimationFrame(renderLoop);
    });

    function initAudio() {
        if(audioCtx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 1024; // ã‚¹ãƒšã‚¯ãƒˆãƒ©ãƒ ç”¨ã«ç´°ã‹ã
        analyser.smoothingTimeConstant = 0.85;
        sourceNode = audioCtx.createMediaElementSource(video);
        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function playNext() {
        if(playlist.length === 0) return;
        if(cruiseTimer) clearTimeout(cruiseTimer);
        const file = playlist.shift();
        playlist.push(file);

        // å‹•ç”»åˆ‡ã‚Šæ›¿ãˆæ™‚ãƒªã‚»ãƒƒãƒˆ
        dynamicMin = 80; dynamicMax = 120; currentInterval = 2000;
        video.src = URL.createObjectURL(file);
        video.play().catch(()=>{});
        video.onloadedmetadata = () => { video.currentTime = video.duration * (0.3 + Math.random() * 0.5); };
        
        const duration = (CRUISE_MIN_SEC + Math.random() * (CRUISE_MAX_SEC - CRUISE_MIN_SEC)) * 1000;
        cruiseTimer = setTimeout(playNext, duration);
    }

    // === ãƒ¡ã‚¤ãƒ³æç”»ãƒ«ãƒ¼ãƒ— ===
    function renderLoop() {
        requestAnimationFrame(renderLoop);
        if(!analyser) return;

        // --- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ‡ãƒ¼ã‚¿å–å¾— ---
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray); // ã‚¹ãƒšã‚¯ãƒˆãƒ©ãƒ ç”¨

        // --- 1. ã‚¹ãƒšã‚¯ãƒˆãƒ©ãƒ æç”» ---
        drawSpectrum(dataArray, bufferLength);

        // --- 2. éŸ³é‡ã‚¨ãƒãƒ«ã‚®ãƒ¼è¨ˆç®— (ãƒãƒ¼ãƒ„ç”¨) ---
        let energy = 0;
        // ä½ã€œä¸­éŸ³åŸŸã®å¹³å‡
        const range = Math.floor(bufferLength * 0.4); 
        for(let i = 0; i < range; i++) energy += dataArray[i];
        energy = energy / range;

        // --- 3. è‡ªå‹•æ­£è¦åŒ– & ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨ˆç®— ---
        if (energy > 10) { // ãƒã‚¤ã‚ºã‚«ãƒƒãƒˆ
            // ã‚†ã£ãã‚Šè¿½å¾“
            if (energy < dynamicMin) dynamicMin = energy; else dynamicMin += 0.1;
            if (energy > dynamicMax) dynamicMax = energy; else dynamicMax -= 0.2;
            if (dynamicMax - dynamicMin < 30) dynamicMax = dynamicMin + 30; // æœ€ä½ãƒ¬ãƒ³ã‚¸ä¿è¨¼
        }
        let ratio = (energy - dynamicMin) / (dynamicMax - dynamicMin);
        if (ratio < 0) ratio = 0; if (ratio > 1) ratio = 1;

        const targetInterval = INTERVAL_SLOW - (ratio * (INTERVAL_SLOW - INTERVAL_FAST));
        currentInterval = currentInterval * 0.9 + targetInterval * 0.1;

        // UIæ›´æ–°
        const percent = Math.round(ratio * 100);
        bpmMeter.innerText = `${(currentInterval/1000).toFixed(2)}s / LV.${percent}`;
        const hue = 180 + (ratio * 180); // é’->èµ¤
        bpmMeter.style.color = `hsl(${hue}, 100%, 60%)`;
        bpmMeter.style.textShadow = `0 0 15px hsl(${hue}, 100%, 50%)`;

        // --- 4. ãƒãƒ¼ãƒ„ç”Ÿæˆ & æç”» ---
        const now = Date.now();
        if (now > nextNoteTime) {
            spawnNote(ratio, hue);
            nextNoteTime = now + currentInterval;
        }
        drawNotes();
    }

    // === ã‚¹ãƒšã‚¯ãƒˆãƒ©ãƒ æç”»é–¢æ•° ===
    function drawSpectrum(data, bufferLen) {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºåˆã‚ã›
        const wrap = specCanvas.parentElement;
        specCanvas.width = wrap.clientWidth; specCanvas.height = wrap.clientHeight;
        const W = specCanvas.width; const H = specCanvas.height;
        sCtx.clearRect(0, 0, W, H);

        const barWidth = (W / bufferLen) * 2.5;
        let barHeight;
        let x = 0;

        for(let i = 0; i < bufferLen; i++) {
            barHeight = data[i] / 255 * H;
            
            // ãƒã‚ªãƒ³ã‚«ãƒ©ãƒ¼ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const hue = i / bufferLen * 360; // è™¹è‰²
            sCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            sCtx.shadowBlur = 10;
            sCtx.shadowColor = `hsl(${hue}, 100%, 50%)`;

            // ä¸‹ã‹ã‚‰ç”Ÿãˆã‚‹ãƒãƒ¼
            sCtx.fillRect(x, H - barHeight, barWidth, barHeight);
            x += barWidth + 1;
            if(x > W) break;
        }
        sCtx.shadowBlur = 0;
    }

    // === ãƒãƒ¼ãƒ„å‡¦ç† ===
    function spawnNote(ratio, hue) {
        // ãƒ¬ãƒ¼ãƒ³ã®å¹…ã‚’å–å¾—
        const laneW = notesCanvas.parentElement.clientWidth;
        
        // æ¿€ã—ã„ã»ã©å¤ªãã€èµ¤ã
        let width = laneW * (0.4 + (ratio * 0.5)); 
        let color = `hsl(${hue}, 100%, 60%)`;

        notes.push({
            y: -30,
            color: color,
            width: width,
            glow: ratio * 30
        });
    }

    function drawNotes() {
        const wrap = notesCanvas.parentElement;
        notesCanvas.width = wrap.clientWidth; notesCanvas.height = wrap.clientHeight;
        const W = notesCanvas.width; const H = notesCanvas.height;
        const hitY = H * 0.8; // åˆ¤å®šãƒ©ã‚¤ãƒ³ä½ç½®ï¼ˆCSSã¨åˆã‚ã›ã‚‹ï¼‰
        nCtx.clearRect(0, 0, W, H);

        for (let i = notes.length - 1; i >= 0; i--) {
            const n = notes[i];
            n.y += NOTE_FALL_SPEED;

            // ãƒã‚ªãƒ³ç™ºå…‰æç”»
            nCtx.shadowBlur = 15 + n.glow;
            nCtx.shadowColor = n.color;
            nCtx.fillStyle = n.color;
            nCtx.globalAlpha = 0.9;
            
            const x = (W - n.width) / 2;
            nCtx.beginPath();
            nCtx.roundRect(x, n.y, n.width, 12, 6);
            nCtx.fill();

            // åˆ¤å®šãƒ©ã‚¤ãƒ³é€šéã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            if (n.y > hitY && n.y < hitY + NOTE_FALL_SPEED + 5) {
                const line = document.getElementById('hit-line');
                line.style.background = n.color;
                line.style.boxShadow = `0 0 30px ${n.color}, 0 0 10px #fff`;
                setTimeout(() => {
                    line.style.background = 'rgba(255,255,255,0.5)';
                    line.style.boxShadow = '0 0 15px #fff, 0 0 5px var(--neon-blue)';
                }, 80);
            }
            if (n.y > H + 50) notes.splice(i, 1);
        }
        nCtx.shadowBlur = 0;
    }
</script>
</body>
</html>
