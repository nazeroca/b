<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>AV Cockpit: Neon Burst Style</title>
    <style>
      /* === ÂÖ®‰ΩìË®≠ÂÆö === */
      :root {
        --bg-color: #050008;
        --panel-bg: #111;
        --accent-pink: #ff0055;
        --accent-blue: #00d2ff;
        --accent-green: #00ff99;
        --accent-yellow: #ffcc00;
        --text-main: #eee;
      }
      body {
        margin: 0;
        overflow: hidden;
        background: var(--bg-color);
        color: var(--text-main);
        font-family: "Courier New", sans-serif;
      }

      /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
      #container {
        display: flex;
        width: 100vw;
        height: 100vh;
      }

      /* === Â∑¶„Ç®„É™„Ç¢ÔºàÂãïÁîª Ôºã „Éé„Éº„ÉÑÔºâ === */
      #stage-left {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #000;
        position: relative;
      }

      /* ÂãïÁîª„Éú„ÉÉ„ÇØ„Çπ */
      #video-box {
        width: 100%;
        background: #000;
        position: relative;
        aspect-ratio: 16 / 9;
        flex-shrink: 0;
        border-bottom: 2px solid var(--accent-pink);
        box-shadow: 0 5px 20px rgba(255, 0, 85, 0.2);
        z-index: 5;
      }
      video {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      /* === „Éé„Éº„ÉÑ„É¨„Éº„É≥ (DOM„Éô„Éº„Çπ„Å´Â§âÊõ¥) === */
      #lane-box {
        flex: 1;
        position: relative;
        background: linear-gradient(
          180deg,
          rgba(15, 23, 42, 1) 0%,
          rgba(0, 0, 0, 1) 100%
        );
        overflow: hidden;
        min-height: 100px;
        /* ËÉåÊôØ„Ç∞„É™„ÉÉ„ÉâÊºîÂá∫ */
        background-image: linear-gradient(
            rgba(0, 255, 255, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 50px 50px;
      }

      /* „Ç≤„Éº„É†„Ç®„É™„Ç¢Ôºà„Éé„Éº„ÉÑ„ÅåÊµÅ„Çå„ÇãÂ†¥ÊâÄÔºâ */
      #notes-game-area {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
      }

      /* === ÁßªÊ§ç„Åï„Çå„Åü„Çπ„Çø„Ç§„É´: Âà§ÂÆö„É©„Ç§„É≥ === */
      #notes-judge-line {
        position: absolute;
        left: 100px;
        top: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(
          180deg,
          rgba(0, 255, 255, 0) 0%,
          rgba(0, 255, 255, 0.8) 50%,
          rgba(0, 255, 255, 0) 100%
        );
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.8),
          0 0 20px rgba(0, 255, 255, 0.5), inset 0 0 20px rgba(0, 255, 255, 0.3);
        z-index: 20;
        animation: judgeLinePulse 2s ease-in-out infinite;
      }
      #notes-judge-line.hit {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0) 0%,
          rgba(255, 255, 255, 1) 50%,
          rgba(255, 255, 255, 0) 100%
        );
        box-shadow: 0 0 30px rgba(0, 255, 255, 1),
          0 0 60px rgba(0, 255, 255, 0.8);
        width: 6px;
        transition: all 0.1s;
      }

      @keyframes judgeLinePulse {
        0%,
        100% {
          opacity: 0.8;
        }
        50% {
          opacity: 1;
        }
      }

      /* === ÁßªÊ§ç„Åï„Çå„Åü„Çπ„Çø„Ç§„É´: „Éé„Éº„ÉÑ === */
      .note {
        position: absolute;
        top: 50%;
        width: 50px;
        height: 50px;
        transform: translateY(-50%);
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(125, 211, 252, 1) 0%,
          rgba(14, 165, 233, 1) 50%,
          rgba(8, 47, 73, 1) 100%
        );
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.6),
          0 0 40px rgba(14, 165, 233, 0.4),
          inset 0 0 20px rgba(255, 255, 255, 0.2);
        z-index: 15;
        will-change: left;
        animation: notePulse 1.5s ease-in-out infinite;
        border: 2px solid rgba(0, 255, 255, 0.5);
      }

      .note::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 30px;
        height: 30px;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.8) 0%,
          transparent 70%
        );
        animation: noteCore 2s ease-in-out infinite;
      }

      @keyframes notePulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(0, 255, 255, 0.6),
            inset 0 0 20px rgba(255, 255, 255, 0.2);
        }
        50% {
          box-shadow: 0 0 30px rgba(0, 255, 255, 0.9),
            inset 0 0 30px rgba(255, 255, 255, 0.4);
        }
      }

      @keyframes noteCore {
        0%,
        100% {
          opacity: 0.6;
          transform: translate(-50%, -50%) scale(0.8);
        }
        50% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.2);
        }
      }

      /* === Âè≥„Ç®„É™„Ç¢Ôºà„Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´Ôºâ === */
      #panel-right {
        width: 320px;
        background: var(--panel-bg);
        border-left: 1px solid #333;
        display: flex;
        flex-direction: column;
        padding: 10px;
        box-sizing: border-box;
        overflow-y: auto;
        z-index: 20;
      }

      .section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #333;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .sec-title {
        font-size: 11px;
        color: var(--accent-blue);
        font-weight: bold;
        border-bottom: 1px solid #444;
        padding-bottom: 4px;
        margin-bottom: 8px;
      }

      .btn-group {
        display: flex;
        gap: 5px;
        margin-bottom: 5px;
      }
      .btn {
        flex: 1;
        padding: 10px;
        border: 1px solid #444;
        background: #222;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: 0.2s;
      }
      .btn:active {
        transform: scale(0.96);
      }
      .btn-main {
        background: var(--accent-pink);
        border-color: var(--accent-pink);
        color: #fff;
      }

      .status-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        align-items: flex-end;
      }
      .status-val {
        font-size: 20px;
        font-weight: bold;
        color: var(--accent-green);
        font-family: monospace;
      }
      .status-lbl {
        font-size: 10px;
        color: #888;
      }

      .prob-bar-bg {
        width: 100%;
        height: 6px;
        background: #333;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 5px;
      }
      .prob-bar-fill {
        height: 100%;
        background: var(--accent-yellow);
        width: 0%;
        transition: width 0.5s;
      }

      /* 12ÊÆµÈöé„Çπ„Éî„Éº„Éâ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
      #speed-steps-wrapper {
        display: flex;
        gap: 3px;
        margin-top: 15px;
        height: 12px;
        align-items: flex-end;
      }
      .speed-step {
        flex: 1;
        background: #333;
        border-radius: 2px;
        height: 100%;
        transition: all 0.3s;
      }

      /* ÂàùÊúüÁîªÈù¢ */
      #init-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .start-btn {
        padding: 15px 40px;
        border: 2px solid #fff;
        background: var(--accent-pink);
        color: #fff;
        font-size: 20px;
        font-weight: bold;
        border-radius: 30px;
        cursor: pointer;
        box-shadow: 0 0 20px var(--accent-pink);
      }
      input[type="file"] {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="stage-left">
        <div id="video-box">
          <video id="mainVideo" playsinline crossorigin="anonymous"></video>
        </div>
        <div id="lane-box">
          <div id="notes-judge-line"></div>
          <div id="notes-game-area"></div>
        </div>
      </div>

      <div id="panel-right">
        <div class="section">
          <div class="sec-title">RHYTHM LOGIC (SKIN TONE)</div>

          <div class="status-row">
            <div class="status-lbl">CHANGE PROBABILITY</div>
            <div
              class="status-val"
              id="disp-prob"
              style="color: var(--accent-yellow)"
            >
              --%
            </div>
          </div>
          <div class="prob-bar-bg">
            <div class="prob-bar-fill" id="bar-prob"></div>
          </div>
          <div
            style="
              font-size: 9px;
              color: #666;
              margin-bottom: 10px;
              text-align: right;
            "
          >
            (SPEED UP CHANCE)
          </div>

          <div class="status-row">
            <div class="status-lbl">CURRENT SPEED</div>
            <div class="status-val" id="disp-speed">3500ms</div>
          </div>

          <div style="font-size: 9px; color: #666; text-align: right">
            NEXT CHECK IN: <span id="disp-timer">20</span>s
          </div>

          <div style="font-size: 9px; color: #888; margin-top: 10px">
            SPEED LEVELS (SLOW -> FAST)
          </div>
          <div id="speed-steps-wrapper"></div>

          <button
            class="btn"
            style="
              width: 100%;
              margin-top: 10px;
              border-color: #00d2ff;
              color: #00d2ff;
            "
            onclick="manualSpeedDown()"
          >
            üîΩ FORCE SLOW (-3 LEVELS)
          </button>
        </div>

        <div class="section">
          <div class="sec-title">VIDEO SOURCE</div>
          <div class="btn-group">
            <label class="btn btn-main"
              >üìÇ LOAD
              <input type="file" id="subFileInput" multiple accept="video/*" />
            </label>
            <button class="btn" onclick="manualSkip()">‚è≠ SKIP</button>
          </div>
          <button
            id="btn-cruise"
            class="btn"
            style="width: 100%"
            onclick="toggleCruise()"
          >
            CRUISE: OFF
          </button>
        </div>
      </div>
    </div>

    <div id="init-overlay">
      <h2 style="color: var(--accent-blue)">
        AV COCKPIT <span style="font-size: 0.5em; color: #888">NEON BURST</span>
      </h2>
      <label class="start-btn"
        >START SYSTEM<input
          type="file"
          id="mainFileInput"
          multiple
          accept="video/*"
      /></label>
    </div>

    <canvas
      id="skin-canvas"
      width="160"
      height="90"
      style="display: none"
    ></canvas>

    <script>
      // === Ë®≠ÂÆöÔºö„Çπ„Éî„Éº„ÉâÊÆµÈöé ===
      const SPEED_LEVELS = [
        5000, 4500, 4000, 3500, 3000, 2500, 2000, 1500, 1250, 1000, 800, 600,
      ];
      const START_INDEX = 3;
      const NOTES_TRAVEL_TIME = 2000; // „Éé„Éº„ÉÑ„ÅåÁ´Ø„Åã„ÇâÂà§ÂÆö„É©„Ç§„É≥„Åæ„ÅßÂà∞ÈÅî„Åô„ÇãÊôÇÈñì(ms)

      // === DOM ===
      const video = document.getElementById("mainVideo");
      const gameArea = document.getElementById("notes-game-area");
      const judgeLine = document.getElementById("notes-judge-line");

      const skinCanvas = document.getElementById("skin-canvas");
      const sCtx = skinCanvas.getContext("2d", { willReadFrequently: true });

      const dispProb = document.getElementById("disp-prob");
      const barProb = document.getElementById("bar-prob");
      const dispSpeed = document.getElementById("disp-speed");
      const dispTimer = document.getElementById("disp-timer");
      const btnCruise = document.getElementById("btn-cruise");
      const initScreen = document.getElementById("init-overlay");
      const stepsWrapper = document.getElementById("speed-steps-wrapper");

      // === Â§âÊï∞ ===
      let playlist = [];
      let cruiseTimer = null;
      let isCruiseMode = false;

      // „É™„Ç∫„É†„É≠„Ç∏„ÉÉ„ÇØÁî®
      let currentSpeedIndex = START_INDEX;
      let currentSkinProb = 0.5;
      let nextNoteTime = 0;
      let secondsLeft = 20;

      // === ÂàùÊúüÂåñ ===
      window.onload = () => {
        // „Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÁîüÊàê
        stepsWrapper.innerHTML = "";
        for (let i = 0; i < SPEED_LEVELS.length; i++) {
          const d = document.createElement("div");
          d.className = "speed-step";
          d.id = `step-${i}`;
          stepsWrapper.appendChild(d);
        }
        updateInfoPanel();
      };

      document
        .getElementById("mainFileInput")
        .addEventListener("change", handleFileSelect);
      document
        .getElementById("subFileInput")
        .addEventListener("change", handleFileSelect);

      function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        playlist = playlist.concat(files);
        shuffleArray(playlist);

        if (initScreen.style.display !== "none") {
          initScreen.style.display = "none";
          playNext();
          startLogicLoop();
        }
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      // === ËÇåËâ≤Ëß£Êûê„É≠„Ç∏„ÉÉ„ÇØ (Á∂≠ÊåÅ) ===
      function analyzeSkinColor() {
        sCtx.drawImage(video, 0, 0, skinCanvas.width, skinCanvas.height);
        const frame = sCtx.getImageData(
          0,
          0,
          skinCanvas.width,
          skinCanvas.height
        );
        const data = frame.data;
        let skinPixels = 0;
        const totalPixels = data.length / 4;

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];

          if (
            r > 95 &&
            g > 40 &&
            b > 20 &&
            r > g &&
            r > b &&
            Math.abs(r - g) > 15 &&
            Math.max(r, g, b) - Math.min(r, g, b) > 15
          ) {
            skinPixels++;
          }
        }
        const ratio = skinPixels / totalPixels;
        currentSkinProb = 0.4 + ratio * 0.6;
        if (currentSkinProb > 1.0) currentSkinProb = 1.0;
        updateInfoPanel();
      }

      // === „Çπ„Éî„Éº„ÉâÂ§âÊõ¥„É≠„Ç∏„ÉÉ„ÇØ (Á∂≠ÊåÅ) ===
      function startLogicLoop() {
        requestAnimationFrame(gameLoop); // „Éé„Éº„ÉÑÁîüÊàê„É´„Éº„Éó

        setInterval(() => {
          if (video.paused) return;
          secondsLeft--;
          if (secondsLeft <= 0) {
            secondsLeft = 20;
            decideSpeedChange();
          }
          dispTimer.innerText = secondsLeft;
        }, 1000);
      }

      function decideSpeedChange() {
        const rand = Math.random();
        if (rand < currentSkinProb) {
          if (currentSpeedIndex < SPEED_LEVELS.length - 1) currentSpeedIndex++;
        } else {
          if (currentSpeedIndex > 0) currentSpeedIndex--;
        }
        updateInfoPanel();
      }

      function manualSpeedDown() {
        currentSpeedIndex -= 3;
        if (currentSpeedIndex < 0) currentSpeedIndex = 0;
        updateInfoPanel();
      }

      function updateInfoPanel() {
        const probPct = (currentSkinProb * 100).toFixed(1);
        dispProb.innerText = `${probPct}%`;
        barProb.style.width = `${probPct}%`;

        const ms = SPEED_LEVELS[currentSpeedIndex];
        dispSpeed.innerText = `${ms}ms`;

        const totalSteps = SPEED_LEVELS.length - 1;
        const ratio = currentSpeedIndex / totalSteps;
        const hue = 180 + ratio * 180;

        dispSpeed.style.color = `hsl(${hue}, 100%, 60%)`;

        for (let i = 0; i < SPEED_LEVELS.length; i++) {
          const el = document.getElementById(`step-${i}`);
          const stepHue = 180 + (i / totalSteps) * 180;

          if (i === currentSpeedIndex) {
            el.style.background = `hsl(${stepHue}, 100%, 60%)`;
            el.style.boxShadow = `0 0 10px hsl(${stepHue}, 100%, 60%)`;
            el.style.opacity = "1";
            el.style.transform = "scaleY(1.4)";
          } else {
            el.style.background = "#333";
            el.style.boxShadow = "none";
            el.style.opacity = "0.5";
            el.style.transform = "scaleY(1.0)";
          }
        }
      }

      // === ‚òÖÂ§âÊõ¥: DOM„Éô„Éº„Çπ„ÅÆ„Éé„Éº„ÉÑÁîüÊàê„É´„Éº„Éó ===
      function gameLoop() {
        requestAnimationFrame(gameLoop);

        const now = Date.now();
        const currentInterval = SPEED_LEVELS[currentSpeedIndex];

        if (!video.paused && now > nextNoteTime) {
          spawnNoteDOM();
          nextNoteTime = now + currentInterval;
        }
      }

      // === ‚òÖÂ§âÊõ¥: DOM„Éé„Éº„ÉÑÁîüÊàê„Å®„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âá¶ÁêÜ ===
      function spawnNoteDOM() {
        const note = document.createElement("div");
        note.className = "note";
        gameArea.appendChild(note);

        const startX = gameArea.offsetWidth; // Âè≥Á´Ø
        const judgeLineX = 100; // Â∑¶„Åã„Çâ100px„ÅÆ‰ΩçÁΩÆ„Å´Âà§ÂÆö„É©„Ç§„É≥
        const dist = startX - judgeLineX;
        const speed = dist / NOTES_TRAVEL_TIME; // px per ms

        const spawnTime = Date.now();
        let hasHit = false;

        function animate() {
          // „Ç≤„Éº„É†ÂÅúÊ≠¢‰∏≠„ÅØÂãï„Åã„Åï„Å™„ÅÑÂ†¥Âêà
          // if(video.paused) return; // ‚Äª‰ªäÂõû„ÅØÊ≠¢„ÇÅ„Å¶„ÇÇÂãï„Åè‰ªïÊßò„Å´„Åó„Åæ„Åô

          const passed = Date.now() - spawnTime;
          const curX = startX - speed * passed;
          note.style.left = `${curX}px`;

          // Âà§ÂÆö
          const noteCenterX = curX + 25; // width 50 / 2
          const judgeLineCenterX = judgeLineX + 2; // width 4 / 2
          const tolerance = 15;

          if (
            !hasHit &&
            Math.abs(noteCenterX - judgeLineCenterX) <= tolerance
          ) {
            hasHit = true;

            // „Éí„ÉÉ„ÉàÊºîÂá∫
            judgeLine.classList.add("hit");
            setTimeout(() => judgeLine.classList.remove("hit"), 100);

            // „Éé„Éº„ÉÑÊ∂àÊªÖ
            note.style.transform = "translateY(-50%) scale(1.5)";
            note.style.opacity = "0";
            note.style.transition = "all 0.1s ease-out";
            setTimeout(() => note.remove(), 100);
            return;
          }

          if (curX < -60) {
            note.remove();
          } else {
            requestAnimationFrame(animate);
          }
        }
        requestAnimationFrame(animate);
      }

      // === ÂÜçÁîüÂà∂Âæ° ===
      function playNext() {
        if (playlist.length === 0) return;
        if (cruiseTimer) clearTimeout(cruiseTimer);

        const file = playlist.shift();
        playlist.push(file);

        video.src = URL.createObjectURL(file);
        video.play().catch(() => {});

        video.onloadedmetadata = () => {
          video.currentTime = video.duration * (0.2 + Math.random() * 0.5);
          setTimeout(() => {
            analyzeSkinColor();
            currentSpeedIndex = START_INDEX;
            secondsLeft = 20;
            updateInfoPanel();
          }, 500);
        };

        if (isCruiseMode) setCruiseTimer();
      }

      function setCruiseTimer() {
        const duration = (30 + Math.random() * 60) * 1000;
        cruiseTimer = setTimeout(playNext, duration);
      }

      function manualSkip() {
        playNext();
      }

      function toggleCruise() {
        isCruiseMode = !isCruiseMode;
        if (isCruiseMode) {
          btnCruise.innerText = "CRUISE: ON";
          btnCruise.style.borderColor = "var(--accent-pink)";
          btnCruise.style.color = "#fff";
          setCruiseTimer();
        } else {
          btnCruise.innerText = "CRUISE: OFF";
          btnCruise.style.borderColor = "#444";
          btnCruise.style.color = "#eee";
          if (cruiseTimer) clearTimeout(cruiseTimer);
        }
      }

      // === M5 BluetoothÊé•Á∂ö ===
      const UUID_S = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
      const UUID_T = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

      async function connectDevice() {
        try {
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ name: "M5-ULTIMATE-STROKER" }],
            optionalServices: [UUID_S],
          });
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(UUID_S);
          const txChar = await service.getCharacteristic(UUID_T);

          await txChar.startNotifications();
          txChar.addEventListener("characteristicvaluechanged", (e) => {
            const str = new TextDecoder().decode(e.target.value);
            // ÂøÖË¶Å„Å™„Çâ„Åì„Åì„Åß„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„Å´ËøΩÂä†„Åß„Åç„Åæ„Åô
          });
          alert("M5 CONNECTED!");
        } catch (e) {
          alert(e);
        }
      }
    </script>
  </body>
</html>
